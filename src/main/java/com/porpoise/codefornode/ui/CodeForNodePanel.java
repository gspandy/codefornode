package com.porpoise.codefornode.ui;

import java.awt.Image;
import java.io.File;
import java.util.List;

import javax.swing.ButtonGroup;

import com.google.common.base.CharMatcher;
import com.google.common.base.Charsets;
import com.google.common.base.Joiner;
import com.google.common.collect.Lists;
import com.google.common.io.Files;
import com.porpoise.codefornode.ui.Swing.OpenMode;

/**
 */
public class CodeForNodePanel extends javax.swing.JPanel {

    /**
     */
    private static final long serialVersionUID = 1L;

    public static interface Controller {
        /**
         * @param xmlFile
         * @param destDir
         * @param pckg
         */
        String generate(String xmlString, File destDir, String pckg, TargetLanguage language);

    }

    private final Controller controller;

    /** Creates new form CodeForNodePanel */
    public CodeForNodePanel(final Controller c) {
        this.controller = c;
        initComponents();
    }

    /**
	 * 
	 */
    void initFromPrefs() {
        Swing.initFromPrefs(this.textFieldDest, "");
        Swing.initFromPrefs(this.textFieldXml, "");
        Swing.initFromPrefs(this.textFieldPackage, "");

        // reload the xml
        // Swing.initFromPrefs(this.textAreaInputXml, "");
        if (!this.textFieldXml.getText().isEmpty()) {
            loadXmlInput(new File(this.textFieldXml.getText()));
        }

        final String language = Swing.getUserPreference("language", TargetLanguage.Scala.name());

        final boolean useScala = TargetLanguage.valueOf(language) == TargetLanguage.Scala;
        this.radioButtonScala.setSelected(useScala);
        this.radioButtonJava.setSelected(!useScala);

        final ButtonGroup languageGroup = new ButtonGroup();
        languageGroup.add(this.radioButtonScala);
        languageGroup.add(this.radioButtonJava);

    }

    public static void main(final String[] args) {
        final Controller c = new Controller() {
            @Override
            public String generate(final String xml, final File destDir, final String pckg, final TargetLanguage language) {
                return String.format("file=%s%ndest=%s%npckg=%s%nlang=%s", xml, destDir.getName(), pckg, language);
            }
        };
        showCodeForNode(c, "Code For Node", "panel demo");
    }

    /**
     * sets the version text which appears on the panel
     * 
     * @param version
     * @return the old verion text
     */
    public String setVersion(final String version) {
        final String oldVersion = this.labelVersion.getText();
        this.labelVersion.setText(version);
        return oldVersion;
    }

    /**
     * @param c
     */
    public static void showCodeForNode(final Controller c, final String title, final String version) {
        Swing.setDefaultTheme();

        // TODO
        final Image icon = null;
        final CodeForNodePanel p = new CodeForNodePanel(c);
        p.initFromPrefs();
        p.setVersion(version);
        Swing.show(title, p, icon);
    }

    /**
     * This method is called from within the constructor to initialize the form. WARNING: Do NOT modify this code. The content of this
     * method is always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jLabel2 = new javax.swing.JLabel();
        buttonGroupLanguage = new javax.swing.ButtonGroup();
        jLabel1 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jPanel1 = new javax.swing.JPanel();
        jScrollPane1 = new javax.swing.JScrollPane();
        textAreaOutput = new javax.swing.JTextArea();
        textFieldDest = new javax.swing.JTextField();
        buttonFind = new javax.swing.JButton();
        textFieldPackage = new javax.swing.JTextField();
        buttonGenerate = new javax.swing.JButton();
        radioButtonScala = new javax.swing.JRadioButton();
        radioButtonJava = new javax.swing.JRadioButton();
        panelInputXml = new javax.swing.JPanel();
        jScrollPane2 = new javax.swing.JScrollPane();
        textAreaInputXml = new javax.swing.JTextArea();
        textFieldXml = new javax.swing.JTextField();
        buttonFindXml = new javax.swing.JButton();
        jLabel4 = new javax.swing.JLabel();
        labelLogo = new javax.swing.JLabel();
        jPanel2 = new javax.swing.JPanel();
        labelTitle = new javax.swing.JLabel();
        labelVersion = new javax.swing.JLabel();

        jLabel2.setText("jLabel2");

        setBackground(java.awt.Color.white);

        jLabel1.setText("Destination Directory:");

        jLabel3.setText("Package Name:");

        jPanel1.setBackground(java.awt.Color.white);
        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder("Output"));

        textAreaOutput.setColumns(20);
        textAreaOutput.setRows(5);
        textAreaOutput.setName("outputTextArea"); // NOI18N
        jScrollPane1.setViewportView(textAreaOutput);

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 634, Short.MAX_VALUE)
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 108, Short.MAX_VALUE)
        );

        textFieldDest.setName("destinationDirectory"); // NOI18N
        textFieldDest.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                textFieldDestKeyReleased(evt);
            }
        });

        buttonFind.setText("Find");
        buttonFind.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                buttonFindMouseClicked(evt);
            }
        });
        buttonFind.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                buttonFindKeyReleased(evt);
            }
        });

        textFieldPackage.setName("packageName"); // NOI18N
        textFieldPackage.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                textFieldPackageKeyReleased(evt);
            }
        });

        buttonGenerate.setText("Generate");
        buttonGenerate.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                buttonGenerateMouseClicked(evt);
            }
        });
        buttonGenerate.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                buttonGenerateKeyReleased(evt);
            }
        });

        radioButtonScala.setMnemonic('S');
        radioButtonScala.setText("Scala");
        radioButtonScala.setToolTipText("Generate Scala Code");

        radioButtonJava.setMnemonic('J');
        radioButtonJava.setText("Java");
        radioButtonJava.setToolTipText("Generate Java Code");

        panelInputXml.setBackground(javax.swing.UIManager.getDefaults().getColor("window"));
        panelInputXml.setBorder(javax.swing.BorderFactory.createTitledBorder("Input XML"));

        textAreaInputXml.setColumns(20);
        textAreaInputXml.setRows(5);
        textAreaInputXml.setName("xmlTextArea"); // NOI18N
        jScrollPane2.setViewportView(textAreaInputXml);

        textFieldXml.setName("inputXmlField"); // NOI18N
        textFieldXml.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                textFieldXmlKeyReleased(evt);
            }
        });

        buttonFindXml.setText("Find");
        buttonFindXml.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                buttonFindXmlMouseClicked(evt);
            }
        });
        buttonFindXml.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                buttonFindXmlKeyReleased(evt);
            }
        });

        jLabel4.setText("Input Xml:");

        javax.swing.GroupLayout panelInputXmlLayout = new javax.swing.GroupLayout(panelInputXml);
        panelInputXml.setLayout(panelInputXmlLayout);
        panelInputXmlLayout.setHorizontalGroup(
            panelInputXmlLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, panelInputXmlLayout.createSequentialGroup()
                .addGap(10, 10, 10)
                .addComponent(jLabel4)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(textFieldXml, javax.swing.GroupLayout.DEFAULT_SIZE, 461, Short.MAX_VALUE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(buttonFindXml)
                .addGap(4, 4, 4))
            .addComponent(jScrollPane2, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 634, Short.MAX_VALUE)
        );
        panelInputXmlLayout.setVerticalGroup(
            panelInputXmlLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(panelInputXmlLayout.createSequentialGroup()
                .addGroup(panelInputXmlLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(textFieldXml, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(buttonFindXml)
                    .addComponent(jLabel4))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane2, javax.swing.GroupLayout.DEFAULT_SIZE, 301, Short.MAX_VALUE))
        );

        labelLogo.setIcon(new javax.swing.ImageIcon(getClass().getResource("/porpoiseSmall.png"))); // NOI18N
        labelLogo.setToolTipText("porpoiseltd.com");

        jPanel2.setBackground(java.awt.Color.white);

        labelTitle.setFont(new java.awt.Font("Meiryo", 0, 13));
        labelTitle.setForeground(java.awt.SystemColor.inactiveCaptionText);
        labelTitle.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        labelTitle.setText("code-for-node");

        labelVersion.setFont(new java.awt.Font("Meiryo", 0, 13));
        labelVersion.setForeground(java.awt.SystemColor.inactiveCaption);
        labelVersion.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        labelVersion.setText("version");

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel2Layout.createSequentialGroup()
                .addContainerGap(164, Short.MAX_VALUE)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(labelVersion, javax.swing.GroupLayout.PREFERRED_SIZE, 122, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(labelTitle, javax.swing.GroupLayout.PREFERRED_SIZE, 233, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap())
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addComponent(labelTitle)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(labelVersion))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addComponent(radioButtonScala)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(radioButtonJava)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 426, Short.MAX_VALUE)
                        .addComponent(buttonGenerate))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jLabel1, javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(jLabel3, javax.swing.GroupLayout.Alignment.TRAILING))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(textFieldDest, javax.swing.GroupLayout.DEFAULT_SIZE, 416, Short.MAX_VALUE)
                                .addGap(6, 6, 6)
                                .addComponent(buttonFind))
                            .addComponent(textFieldPackage, javax.swing.GroupLayout.DEFAULT_SIZE, 497, Short.MAX_VALUE)))
                    .addComponent(panelInputXml, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(labelLogo)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(labelLogo)
                    .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(panelInputXml, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(textFieldDest, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(buttonFind))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel3)
                    .addComponent(textFieldPackage, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(buttonGenerate)
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(radioButtonScala)
                        .addComponent(radioButtonJava)))
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    private void buttonFindXmlMouseClicked(final java.awt.event.MouseEvent evt) {// GEN-FIRST:event_buttonFindXmlMouseClicked
        onFindXmlInput();
    }// GEN-LAST:event_buttonFindXmlMouseClicked

    private void buttonFindXmlKeyReleased(final java.awt.event.KeyEvent evt) {// GEN-FIRST:event_buttonFindXmlKeyReleased
        if (Swing.isEnter(evt)) {
            onFindXmlInput();
        }
    }// GEN-LAST:event_buttonFindXmlKeyReleased

    private void onFindXmlInput() {
        Swing.find(this, this.textFieldXml, OpenMode.FILES_ONLY);
        final String fileName = this.textFieldXml.getText();
        if (!fileName.isEmpty()) {
            loadXmlInput(new File(fileName));
        }
    }

    private void loadXmlInput(final File file) {
        if (file.exists()) {
            if (!file.isFile()) {
                Swing.showError(this, String.format("%s is not a file", file.getName()));
            } else {
                try {
                    final String xml = Files.toString(file, Charsets.UTF_8);
                    setInputXml(xml);
                } catch (final Exception e) {
                    Swing.showError(this, String.format("Error reading %s: %s", file.getName(), e.getMessage()));
                }
            }
        }

    }

    private void setInputXml(final String xml) {
        this.textAreaInputXml.setText(xml);
    }

    /**
	 * 
	 */
    private void doGenerate() {
        final File xmlFile = new File(this.textFieldXml.getText());
        final File destDir = new File(this.textFieldDest.getText());
        final String pckg = this.textFieldPackage.getText();

        final List<String> errors = Lists.newArrayList();
        if (!CharMatcher.JAVA_LETTER.or(CharMatcher.is('.')).matchesAllOf(pckg)) {
            errors.add(String.format("Invalid java package '%s'", pckg));
        }
        if (!xmlFile.exists()) {
            errors.add(String.format("Couldn't find input file '%s'", xmlFile.getPath()));
        }
        if (destDir.exists()) {
            if (!destDir.isDirectory()) {
                errors.add(String.format("'%s' is not a directory", destDir.getPath()));
            }
        } else if (!destDir.mkdirs()) {
            errors.add(String.format("Couldn't create directory '%s'", destDir.getPath()));
        }

        savePrefs();

        if (errors.isEmpty()) {
            final String results = this.controller.generate(this.textAreaInputXml.getText(), destDir, pckg, getTargetLanguage());
            this.textAreaOutput.setText(results);
        } else {
            final String errorMsg = Joiner.on(String.format(",%n")).join(errors);
            Swing.showError(this, errorMsg);
        }
    }

    /**
	 * 
	 */
    public void savePrefs() {
        Swing.savePrefs(this.textFieldPackage);
        Swing.savePrefs(this.textFieldXml);
        Swing.savePrefs(this.textFieldDest);
        // Swing.savePrefs(this.textAreaInputXml);
        Swing.savePrefs("language", getTargetLanguage().name());
    }

    public TargetLanguage getTargetLanguage() {
        if (this.radioButtonScala.isSelected()) {
            return TargetLanguage.Scala;
        }
        return TargetLanguage.Java;
    }

    private void buttonFindKeyReleased(final java.awt.event.KeyEvent evt) {// GEN-FIRST:event_buttonFindKeyReleased
                                                                           // TODO add your handling code here:
    }// GEN-LAST:event_buttonFindKeyReleased

    private void textFieldPackageKeyReleased(final java.awt.event.KeyEvent evt) {// GEN-FIRST:event_textFieldPackageKeyReleased
        if (Swing.isEnter(evt)) {
            doGenerate();
        }
    }// GEN-LAST:event_textFieldPackageKeyReleased

    private void textFieldDestKeyReleased(final java.awt.event.KeyEvent evt) {// GEN-FIRST:event_textFieldDestKeyReleased
        if (Swing.isEnter(evt)) {
            Swing.find(this, this.textFieldDest, OpenMode.DIRECTORIES_ONLY);
        }
    }// GEN-LAST:event_textFieldDestKeyReleased

    private void textFieldXmlKeyReleased(final java.awt.event.KeyEvent evt) {// GEN-FIRST:event_textFieldXmlKeyReleased
        if (Swing.isEnter(evt)) {
            onFindXmlInput();
        }
    }// GEN-LAST:event_textFieldXmlKeyReleased

    private void buttonFindMouseClicked(final java.awt.event.MouseEvent evt) {// GEN-FIRST:event_buttonFindMouseClicked
        Swing.find(this, this.textFieldDest, OpenMode.DIRECTORIES_ONLY);
    }// GEN-LAST:event_buttonFindMouseClicked

    private void buttonGenerateMouseClicked(final java.awt.event.MouseEvent evt) {// GEN-FIRST:event_buttonGenerateMouseClicked
        doGenerate();
    }// GEN-LAST:event_buttonGenerateMouseClicked

    private void buttonGenerateKeyReleased(final java.awt.event.KeyEvent evt) {// GEN-FIRST:event_buttonGenerateKeyReleased
        if (Swing.isEnter(evt)) {
            doGenerate();
        }
    }// GEN-LAST:event_buttonGenerateKeyReleased

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton buttonFind;
    private javax.swing.JButton buttonFindXml;
    private javax.swing.JButton buttonGenerate;
    private javax.swing.ButtonGroup buttonGroupLanguage;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane2;
    private javax.swing.JLabel labelLogo;
    private javax.swing.JLabel labelTitle;
    private javax.swing.JLabel labelVersion;
    private javax.swing.JPanel panelInputXml;
    private javax.swing.JRadioButton radioButtonJava;
    private javax.swing.JRadioButton radioButtonScala;
    private javax.swing.JTextArea textAreaInputXml;
    private javax.swing.JTextArea textAreaOutput;
    private javax.swing.JTextField textFieldDest;
    private javax.swing.JTextField textFieldPackage;
    private javax.swing.JTextField textFieldXml;
    // End of variables declaration//GEN-END:variables

}
